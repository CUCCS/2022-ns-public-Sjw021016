# 基于 VirtualBox 的网络攻防基础环境搭建

## 实验目的
---

- 掌握 VirtualBox 虚拟机的安装与使用；
- 掌握 VirtualBox 的虚拟网络类型和按需配置；
- 掌握 VirtualBox 的虚拟硬盘多重加载；

## 实验环境
---
本次实验需要使用的网络节点说明：

- VirtualBox 虚拟机
- 攻击者主机（Attacker）：Kali
- 网关（Gateway, GW）：Debian
- 靶机（Victim）：Debian / xp-sp3 / Kali

## 实验要求
---

- 虚拟硬盘配置成多重加载

- 搭建满足如下拓扑图所示的虚拟机网络拓扑；

![网络拓扑图](img/Network_topology_diagram.png)

- 完成以下网络连通性测试；

  - 靶机可以直接访问攻击者主机
  - 攻击者主机无法直接访问靶机
  - 网关可以直接访问攻击者主机和靶机
  - 靶机的所有对外上下行流量必须经过网关
  - 所有节点均可以访问互联网

## 实验步骤

### 1.配置虚拟硬盘多重加载

---

- VirtualBox 的虚拟硬盘多重加载技术、是其一个高级特性，该特性允许你在配置完成系统后，以你现在的配置为基础镜像建立新的虚拟机，完全类似于 Docker 镜像的结构，在只读的基础镜像上进行差异文件的读写，因此能够极大地减少硬盘空间占用、以及减少创建虚拟机的时间占用。

  - 点击管理 -> 虚拟硬盘管理（快捷键ctrl + D）-> 属性 -> 类型即可切换成多重加载模式。如图所示：
  ![Multiple_loading](img/Multiple_loading.png)

### 2.搭建虚拟机网络拓扑

---

**网关需四块网卡**

- NAT网络，使网关可访问攻击者主机；
- 仅主机（Host-Only）网络，进行网卡设置；
- 内部网络intnet1，搭建局域网1；
- 内部网络intnet2，搭建局域网2。

![gw](img/gw.png)

**攻击者需三块网卡**

- NAT网络;
- 两块不同的Host-Only.

![attacker](img/attacker.png)

**victim**

- 内部网络;
victim-xp-1 与 victim-kali-1 在同一局域网 network 1 ; victim-xp-2 与 victim-debian-2 在同一局域网 network2 ;
如下所示
![intnet1](img/intnet1.png)
![intnet2](img/intnet2.png)

### 3.连通性测试

---

**各虚拟机ip地址汇总**

|节点|ip地址|
|:---:|:---:|
|Kali Attacker|10.0.2.15|
|Kali Victim1	|172.16.111.111|
|Windows XP Victim1|169.254.51.76|
|Debian10 Victim2|172.16.222.117|	
|Windows XP Victim2|172.16.222.122|

**3-1: 靶机可以直接访问攻击者主机**
- victim1 -> attacker
![v1-att](img/v1-att.png)
- victim2 -> attacker
![v2-att](img/v2-att.png)

**3-2: 攻击者主机无法直接访问靶机**
- attacker -> victim1
![att-v1](img/att-v1.png)
- attacker -> victim2
![att-v2](img/att-v2.png)

**3-3: 网关可以直接访问攻击者主机和靶机**
- gw -> attacker
![gw-att](img/gw-att.png)

- gw -> victim1
![gw-victim1](img/gw-victim1.png)

- gw -> victim2
![gw-victim2](img/gw-victim2.png)

- gw -> winxp_victim2
  - 以网关 ping wins_xp_victim2为例，在关闭wins_xp 的防火墙之前是 ping 不通的，只有在关闭wins_xp 的防火墙之后网关才能直接访问局域网2 中的靶机
![gw-winsxp](img/gw-winxp.png)

**3-4: 靶机的所有对外上下行流量必须经过网关**

以wins_xp_victims为例：  
首先展示一下 gw 的网卡配置：
![gw_enp0s](img/gw_enp0s.png)

- 在靶机上使用命令 `tracert www.baidu.com`,如图所示;
![tracert](img/tracert.png)
第一跳的ip地址172.16.222.1就是网关内部网络2的地址
- 在网关上使用`tcpdump`命令抓包。
  >-c：指定要抓取的包数量。
  >
  >-i interface：指定tcpdump需要监听的接口。默认会抓取第一个网络接口
  >
  >-n：对地址以数字方式显式，否则显式为主机名，也就是说-n选项不做主机名解析。
  >
  >-nn：除了-n的作用外，还把端口显示为数值，否则显示端口服务名。

  如图所示：
![tcpdump](img/tcpdump.png)
  也可以证明靶机的所有对外上下行流量必须经过网关。
  
**3-5: 所有节点均可以访问互联网**
- gw -> internet
![gw-internet](img/gw-internet.png)

- attacker -> internet
![att-internet](img/att-internet.png)

- victim1 -> internet
![v1-internet](img/v1-internet.png)

- victim2 -> internet
![v2-internet](img/v2-internet.png)

## 参考资料

---

- [多重加载](https://expoli.tech/articles/2021/06/07/1623066136894.html)

- [VMware虚拟机三种网络模式详解_host-only](https://www.linuxidc.com/Linux/2016-09/135521p3.htm)

- [VMware虚拟机三种网络模式详解_NAT地址转换](https://www.linuxidc.com/Linux/2016-09/135521p2.htm)

- [关闭xp系统防火墙的方法](https://www.xitongtiandi.net/wenzhang/xp/47059.html#:~:text=%E5%85%B3%E9%97%ADxp%E7%B3%BB%E7%BB%9F%E9%98%B2%E7%81%AB%E5%A2%99%E7%9A%84%E6%96%B9%E6%B3%95%201.%E9%BC%A0%E6%A0%87%E7%82%B9%E5%87%BB%E6%A1%8C%E9%9D%A2%E5%B7%A6%E4%B8%8B%E8%A7%92%E7%9A%84%E5%BC%80%E5%A7%8B%E6%8C%89%E9%92%AE%EF%BC%8C%E5%9C%A8%E5%BC%80%E5%A7%8B%E8%8F%9C%E5%8D%95%E4%B8%AD%E6%89%BE%E5%88%B0%E5%B9%B6%E6%89%93%E5%BC%80%E6%8E%A7%E5%88%B6%E9%9D%A2%E6%9D%BF%E9%80%89%E9%A1%B9%E3%80%82,2.%E6%8E%A5%E7%9D%80%E5%9C%A8%E6%8E%A7%E5%88%B6%E9%9D%A2%E6%9D%BF%E4%B8%AD%E6%89%BE%E5%88%B0%E2%80%9CWindows%E9%98%B2%E7%81%AB%E5%A2%99%E9%80%89%E9%A1%B9%E2%80%9D%E6%89%93%E5%BC%80%E3%80%82%203.%E5%9C%A8%E9%98%B2%E7%81%AB%E5%A2%99%E8%AE%BE%E7%BD%AE%E7%95%8C%E9%9D%A2%E4%B8%AD%E9%80%89%E6%8B%A9%E2%80%9C%E5%85%B3%E9%97%AD%E2%80%9D%EF%BC%8C%E6%8E%A5%E7%9D%80%E7%82%B9%E5%87%BB%E7%A1%AE%E5%AE%9A%E5%8D%B3%E5%8F%AF%E3%80%82)

- [Linux tcpdump 网关抓包](https://blog.csdn.net/qq_34730511/article/details/102661037)